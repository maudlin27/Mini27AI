---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by maudlin27.
--- DateTime: 16/06/2024 20:35
---
local M27ParentDetails = import('/mods/Mini27AI/lua/AI/M27ParentDetails.lua')
local M27Map = import('/mods/Mini27AI/lua/AI/M27Map.lua')

local M27InitializeArmies = InitializeArmies
InitializeArmies = function()
    M27ParentDetails.ConsiderIfLoudActive()
    LOG('M27 InitializeArmies start, M27ParentDetails.bLoudModActive='..tostring(M27ParentDetails.bLoudModActive or false))
    if M27ParentDetails.bLoudModActive then
        if ArmyBrains then
            for iBrain, oBrain in ArmyBrains do
                LOG('oBrain='..(oBrain.Nickname or 'nil')..'; ArmyIsCivilian(oBrain)='..tostring(ArmyIsCivilian(oBrain:GetArmyIndex()))..'; Brain type is AI='..tostring( oBrain.BrainType == 'AI'))
                if oBrain.BrainType == 'AI' and not(ArmyIsCivilian(oBrain:GetArmyIndex())) then
                    --If we have no team, or our team is an odd number, then use M27
                    local iTeam = oBrain.Team or ScenarioInfo.ArmySetup[oBrain.Name].Team or -1
                    LOG('WIll consider applying M27 logic if are an odd team or not specified, iTeam='..iTeam)
                    --For some reason the .Team odd and even values are switched from what is shown in the lobby
                    if tonumber(ScenarioInfo.Options.M27Teams) == 2 or iTeam <= 0 or iTeam == 2 or iTeam == 4 or iTeam == 6 or iTeam == 8 then
                        LOG('Will apply M27 logic to the AI')
                        oBrain.Mini27AI = true
                        ForkThread(M27Map.SetupMap, oBrain)
                    end
                end
            end
        end

        local loudUtils = import('/lua/loudutilities.lua')

        --Loop through active mods
        for i, m in __active_mods do

            -- Some custom Scenario variables to support certain mods

            if m.name == 'Metal World' then
                LOG("*AI DEBUG METAL WORLD Installed")
                ScenarioInfo.MetalWorld = true
            end

            if m.name == 'Mass Point RNG' then
                LOG("*AI DEBUG Mass Point RNG Installed")
                ScenarioInfo.MassPointRNG = true
            end

        end

        import('/lua/sim/scenarioutilities.lua').CreateResources()

        import('/lua/sim/scenarioutilities.lua').CreateProps()

        ScenarioInfo.biggestTeamSize = 0

        local function InitializeSkirmishSystems(self)
            if self.MiniM27AI then
                self.CheatingAI = false
            end
            -- store which team we're on
            if ScenarioInfo.ArmySetup[self.Name].Team == 1 then
                self.Team = -1 * self.ArmyIndex  -- no team specified
            else
                self.Team = ScenarioInfo.ArmySetup[self.Name].Team  -- specified team number
            end

            local Opponents = 0
            local TeamSize = 1

            -- calculate team sizes
            for index, playerInfo in ArmyBrains do

                if ArmyIsCivilian(playerInfo.ArmyIndex) or index == self.ArmyIndex then continue end

                if IsAlly( index, self.ArmyIndex) then
                    TeamSize = TeamSize + 1
                else
                    Opponents = Opponents + 1
                end

            end

            local color = ScenarioInfo.ArmySetup[self.Name].WheelColor

            SetArmyColor(self.ArmyIndex, color[1], color[2], color[3])

            -- Don't need WheelColor anymore, so delete it
            ScenarioInfo.ArmySetup[self.Name].WheelColor = nil

            if ScenarioInfo.Options.AIFactionColor == 'on' and self.BrainType ~= 'Human' then
                -- These colours are based on the lobby faction dropdown icons
                if self.FactionIndex == 1 then
                    SetArmyColor(self.ArmyIndex, 44, 159, 200)
                elseif self.FactionIndex == 2 then
                    SetArmyColor(self.ArmyIndex, 104, 171, 77)
                elseif self.FactionIndex == 3 then
                    SetArmyColor(self.ArmyIndex, 255, 0, 0)
                elseif self.FactionIndex == 4 then
                    SetArmyColor(self.ArmyIndex, 254, 189, 44)
                end
            end

            -- number of Opponents in the game
            self.NumOpponents = Opponents

            -- default outnumbered ratio
            self.OutnumberedRatio = 1

            -- number of players in the game
            self.Players = ScenarioInfo.Options.PlayerCount

            LOG("*AI DEBUG "..self.Nickname.." Team "..self.Team.." Teamsize is "..TeamSize.." Opponents is "..Opponents)

            self.TeamSize = TeamSize

            if self.TeamSize > ScenarioInfo.biggestTeamSize then
                ScenarioInfo.biggestTeamSize = TeamSize
            end
            if self.Mini27AI then return end --ADDED TO SEE IF MEANS WE TAKE OVER
            -- don't do anything else for a human player
            if self.BrainType == 'Human' then
                return
            end

            self.OutnumberedRatio = math.max( 1, ScenarioInfo.biggestTeamSize/self.TeamSize )

            if self.OutnumberedRatio > 1 then
                LOG("*AI DEBUG "..self.Nickname.." OutnumberedRatio is "..self.OutnumberedRatio)
            end

            -- put some initial threat at all enemy positions
            for k,brain in ArmyBrains do

                --LOG("*AI DEBUG Reviewing Brain "..repr(brain.Nickname).." "..repr(brain) )

                if self.ArmyIndex != brain.ArmyIndex and brain.Nickname != 'civilian' and (not brain:IsDefeated()) and (not IsAlly(self.ArmyIndex, brain.ArmyIndex)) then

            local place = brain:GetStartVector3f()
            local threatlayer = 'AntiAir'

            --LOG("*AI DEBUG "..brain.Nickname.." "..brain.BrainType.." enemy found at "..repr(place).." posting Economy threat")

            -- assign 500 ecothreat for 10 minutes
            self:AssignThreatAtPosition( place, 5000, 0.005, 'Economy' )
            end
            end

            if ScenarioInfo.Options.AIResourceSharing == 'off' then

                self:SetResourceSharing(false)

            elseif ScenarioInfo.Options.AIResourceSharing == 'aiOnly' then

                local allPlayersAI = true

                for i, playerInfo in ArmyBrains do

                    -- If this AI is allied to a human, disable resource sharing
                    if IsAlly(i, self.ArmyIndex) and playerInfo.BrainType == 'Human' then

                        self:SetResourceSharing(false)
                        break

                    end

                end

            else
                self:SetResourceSharing(true)
            end

            -- Create the Condition monitor
            self.ConditionsMonitor = import('/lua/sim/BrainConditionsMonitor.lua').CreateConditionsMonitor(self)

            -- Create the Economy Data structures and start Economy monitor thread
            self:ForkThread1(loudUtils.EconomyMonitor)

            -- Base counters
            self.NumBases = 0
            self.NumBasesLand = 0
            self.NumBasesNaval = 0

            -- Veterancy multiplier
            self.VeterancyMult = 1.0

            -- Create the SelfUpgradeIssued counter
            -- holds the number of units that have recently issued a self-upgrade
            -- is used to limit the # of self-upgrades that can be issued in a given time
            -- to avoid having more than X units trying to upgrade at once
            self.UpgradeIssued = 0

            self.UpgradeIssuedLimit = 1
            self.UpgradeIssuedPeriod = 225

            -- if outnumbered increase the number of simultaneous upgrades allowed
            -- and reduce the waiting period by 2 seconds ( about 10% )
            if self.OutnumberedRatio > 1.0 then

                self.UpgradeIssuedLimit = self.UpgradeIssuedLimit + 1
                self.UpgradeIssuedPeriod = self.UpgradeIssuedPeriod - 20

                -- if really outnumbered do this a second time
                if self.OutnumberedRatio > 1.5 then

                    self.UpgradeIssuedLimit = self.UpgradeIssuedLimit + 1
                    self.UpgradeIssuedPeriod = self.UpgradeIssuedPeriod - 20

                    -- if really badly outnumbered then we do it a 3rd time
                    if self.OutnumberedRatio > 2.0 then

                        self.UpgradeIssuedLimit = self.UpgradeIssuedLimit + 1
                        self.UpgradeIssuedPeriod = self.UpgradeIssuedPeriod - 20

                    end
                end
            end

            LOG("*AI DEBUG "..self.Nickname.." Upgrade Issued Limit is "..self.UpgradeIssuedLimit.." Standard Upgraded Issued Delay Period is "..self.UpgradeIssuedPeriod )

            -- set the base radius according to map size -- affects platoon formation radius and base alert radius
            local mapSizex = ScenarioInfo.size[1]

            local BuilderRadius = math.max(90, (mapSizex/16)) -- should give a range between 90 and 256+
            local BuilderRadius = math.min(BuilderRadius, 140) -- and then limit it to no more than 140

            local RallyPointRadius = 49	-- create automatic rally points at 49 from centre

            -- Set the flag that notes if an expansion base is being setup -- when an engineer takes on an expansion task, he'll set this flag to true
            -- when he dies or starts building the new base, he'll set it back to false
            -- we use this to keep the AI from doing more than one expansion at a time
            self.BaseExpansionUnderway = false

            -- level AI starting locations
            --loudUtils.LevelStartBaseArea(self:GetStartVector3f(), RallyPointRadius )

            -- Create the Builder Managers for the MAIN base
            self:AddBuilderManagers(self:GetStartVector3f(), BuilderRadius, 'MAIN', false, RallyPointRadius, true, 'FRONT')

            -- turn on the PrimaryLandAttackBase flag for MAIN
            self.BuilderManagers.MAIN.PrimaryLandAttackBase = true
            self.PrimaryLandAttackBase = 'MAIN'

            -- Create the Strategy Manager (disabled) from the Sorian AI
            --self.BuilderManagers.MAIN.StrategyManager = StratManager.CreateStrategyManager(self, 'MAIN', self:GetStartVector3f(), 100)

            -- create Persistent Pool platoons

            -- for isolating structures (used by LOUD AI)
            local structurepool = self:MakePlatoon('StructurePool','none')

            structurepool:UniquelyNamePlatoon('StructurePool')
            structurepool.BuilderName = 'Struc'
            structurepool.UsingTransport = true     -- insures that it never gets reviewed in a merge operation

            self.StructurePool = structurepool

            -- for isolating aircraft low on fuel (used by LOUD AI)
            local refuelpool = self:MakePlatoon('RefuelPool','none')

            refuelpool:UniquelyNamePlatoon('RefuelPool')
            refuelpool.BuilderName = 'Refuel'
            refuelpool.UsingTransport = true        -- never gets reviewed in a merge --

            self.RefuelPool = refuelpool

            -- the standard Army Pool
            local armypool = self:GetPlatoonUniquelyNamed('ArmyPool')

            armypool:UniquelyNamePlatoon('ArmyPool')
            armypool.BuilderName = 'Army'

            self.ArmyPool = armypool


            -- Start the Dead Base Monitor
            self:ForkThread1( loudUtils.DeadBaseMonitor )

            -- Start the Enemy Picker
            self:ForkThread1( loudUtils.PickEnemy )

            -- Start the Path Generator
            self:ForkThread1( loudUtils.PathGeneratorThread )

            -- start PlatoonDistressMonitor
            self:ForkThread1( loudUtils.PlatoonDistressMonitor )

            -- start watching the intel data
            self:ForkThread1( loudUtils.ParseIntelThread )

            -- record the starting unit cap
            -- caps of 1000+ trigger some conditions
            self.StartingUnitCap = GetArmyUnitCap(self.ArmyIndex)

            if self.CheatingAI then
                import('/lua/ai/aiutilities.lua').SetupAICheat( self )
            end

            if self.OutnumberedRatio > 1.5 and (self.VeterancyMult < self.OutnumberedRatio) then

                local AISendChat = import('/lua/ai/sorianutilities.lua').AISendChat

                ForkThread( AISendChat, 'enemies', self.Nickname, "WOW - Why dont you just beat me with a stick?" )
                ForkThread( AISendChat, 'enemies', self.Nickname, "You Outnumber me "..tostring(self.OutnumberedRatio).." to 1 !")
                ForkThread( AISendChat, 'enemies', self.Nickname, "And all you give me is a "..tostring(self.VeterancyMult).." bonus?")

            end

        end


        local tblGroups = {}
        local tblArmy = ListArmies()

        local civOpt = ScenarioInfo.Options.CivilianAlliance
        local bCreateInitial = ShouldCreateInitialArmyUnits()

        -- setup teams and civilians, add custom units, wrecks
        -- call out to Initialize SkirimishSystems (a great deal of AI setup)
        for iArmy, strArmy in pairs(tblArmy) do

            -- release some data we don't need anymore
            ScenarioInfo.ArmySetup[strArmy].BadMap = nil
            ScenarioInfo.ArmySetup[strArmy].LEM = nil
            ScenarioInfo.ArmySetup[strArmy].MapVersion = nil
            ScenarioInfo.ArmySetup[strArmy].Ready = nil
            ScenarioInfo.ArmySetup[strArmy].StartSpot = nil

            local tblData = ScenarioInfo.Env.Scenario.Armies[strArmy]
            local armyIsCiv = ScenarioInfo.ArmySetup[strArmy].Civilian

            tblGroups[ strArmy ] = {}

            if tblData then

                -- setup neutral/enemy status of civlians --
                -- and allied status of other players --
                for iEnemy, strEnemy in pairs(tblArmy) do

                    local enemyIsCiv = ScenarioInfo.ArmySetup[strEnemy].Civilian

                    -- if another army and you AND they are NOT NEUTRAL civilians --
                    if iArmy != iEnemy and strArmy != 'NEUTRAL_CIVILIAN' and strEnemy != 'NEUTRAL_CIVILIAN' then

                if (armyIsCiv or enemyIsCiv) and civOpt == 'neutral' then
                SetAlliance( iArmy, iEnemy, 'Neutral')
                else
                SetAlliance( iArmy, iEnemy, 'Enemy')
                end

                -- in order to be ALLIED - players must be on specific teams --
                if ScenarioInfo.ArmySetup[strArmy].Team != 1 then

                if ScenarioInfo.ArmySetup[strArmy].Team == ScenarioInfo.ArmySetup[strEnemy].Team then
                SetAlliance( iArmy, iEnemy, 'Ally')
                end

                end

                -- if only they are NEUTRAL civilians
                elseif strArmy == 'NEUTRAL_CIVILIAN' or strEnemy == 'NEUTRAL_CIVILIAN' then

                SetAlliance( iArmy, iEnemy, 'Neutral')
                    end

                end

                -- if this is not civilian - mark the use of certain mods
                -- and add custom unit tables to each AI
                if not armyIsCiv then
                    loudUtils.AddCustomUnitSupport(GetArmyBrain(strArmy))
                end

                SetArmyEconomy( strArmy, tblData.Economy.mass, tblData.Economy.energy)

                if not armyIsCiv then
                    -- this insures proper setting of teammate counts and
                    -- calculation of the largest team size for ALL players (human and AI)
                    InitializeSkirmishSystems( GetArmyBrain(strArmy) )
                end

                if (not armyIsCiv and bCreateInitial) or (armyIsCiv and civOpt != 'removed') then

            local commander = (not ScenarioInfo.ArmySetup[strArmy].Civilian)
            local cdrUnit

            tblGroups[strArmy], cdrUnit = CreateInitialArmyGroup( strArmy, commander)

            if commander and cdrUnit and ArmyBrains[iArmy].Nickname then
            cdrUnit:SetCustomName( ArmyBrains[iArmy].Nickname )
            end

            end

            local wreckageGroup = FindUnitGroup('WRECKAGE', ScenarioInfo.Env.Scenario.Armies[strArmy].Units)

            -- if there is wreckage to be created --
            if wreckageGroup then

            local platoonList, tblResult, treeResult = CreatePlatoons(strArmy, wreckageGroup )

            for num,unit in tblResult do
            -- all wrecks created here get 1800 second lifetime (30 minutes)
            unit:CreateWreckageProp(0, 1800)
            unit:Destroy()
                end

                end

            end

        end



        if ScenarioInfo.Env.Scenario.Areas.AREA_1 then

            LOG("*AI DEBUG ScenarioInfo Map is "..repr(ScenarioInfo.Env.Scenario.Areas) )



            import('/lua/scenarioframework.lua').SetPlayableArea( 'AREA_1', false )

        end

        ScenarioInfo.Configurations = nil

        ScenarioInfo.TeamMassPointList = {}

        --3+ Teams Unit Cap Fix, setting up the Unit Cap part of SetupAICheat,
        -- get each AI to build it's scouting locations
        -- now that we know what is the number of armies in the biggest team.
        for _, strArmy in tblArmy do

            local armyIsCiv = ScenarioInfo.ArmySetup[strArmy].Civilian

            local aiBrain = GetArmyBrain(strArmy)

            if aiBrain.BrainType == 'AI' and not armyIsCiv then

                loudUtils.BuildScoutLocations(aiBrain)

                import('/lua/ai/aiutilities.lua').SetupAICheatUnitCap( aiBrain, ScenarioInfo.biggestTeamSize )

                if not ScenarioInfo.TeamMassPointList[aiBrain.Team] then

                    LOG("*AI DEBUG Creating Starting Mass Point List for Team "..aiBrain.Team)

                    ScenarioInfo.TeamMassPointList[aiBrain.Team] = {}

                    -- each team is intially allocated the entire mass point list
                    if ScenarioInfo.StartingMassPointList[1] then
                        ScenarioInfo.TeamMassPointList[aiBrain.Team] = table.copy(ScenarioInfo.StartingMassPointList)
                    end

                end

                aiBrain.StartingMassPointList = {}  -- initialize starting mass point list for this brain

                -- each brain can store a different amount of points, based upon team size, player count and OutnumberedRatio
                aiBrain.MassPointShare = math.min( 12 + ScenarioInfo.Options.PlayerCount, math.floor(ScenarioInfo.NumMassPoints/ScenarioInfo.Options.PlayerCount) - 1)

                if aiBrain.OutnumberedRatio >= aiBrain.CheatValue then
                    aiBrain.MassPointShare = math.min( math.floor(ScenarioInfo.NumMassPoints/ScenarioInfo.Options.PlayerCount), math.floor(aiBrain.MassPointShare * (aiBrain.OutnumberedRatio/aiBrain.CheatValue)))
                end
            end

        end

        for k, v in ScenarioInfo.TeamMassPointList do

            LOG("*AI DEBUG Processing TeamMassPoints for team "..repr(k))

            local count = 0
            local apply = true

            while apply do

                apply = false

                for a, brain in ArmyBrains do

                    if count < brain.MassPointShare then

                        if brain.BrainType == 'AI' and brain.Team == k then

                            if count == 0 then
                                LOG("*AI DEBUG "..brain.Nickname.." storing "..brain.MassPointShare.." Mass Points")
                            end

                            local Position = { brain.StartPosX, 0, brain.StartPosZ }

                            -- sort the list for closest
                            table.sort(ScenarioInfo.TeamMassPointList[brain.Team], function(a,b) return VDist3( a.Position, Position ) < VDist3( b.Position, Position) end )

                            -- take the closest one and remove it from master list
                            table.insert( brain.StartingMassPointList, table.remove( ScenarioInfo.TeamMassPointList[brain.Team], 1 ))

                            apply = true

                        end

                    else
                        --if brain.BrainType == 'AI' and brain.Team == k and count == brain.MassPointShare + 1 then
                        --  LOG("*AI DEBUG "..brain.Nickname.." Starting Mass Point list is "..repr(brain.StartingMassPointList))
                        --end
                    end

                end

                count = count + 1

            end

        end

        loudUtils.StartAdaptiveCheatThreads()

        --loudUtils.StartSpeedProfile()     -- this was a crude benchmarking tool

        ScenarioInfo.StartingMassPointList = nil
        ScenarioInfo.TeamMassPointList = nil

        ScenarioInfo.Options.AIResourceSharing = nil
        ScenarioInfo.Options.AIFactionColor = nil

        return tblGroups
    else
        M27InitializeArmies()
    end
end